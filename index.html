<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Govee Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>Govee Dashboard2</h1>
  <div id="sensors"></div>

  <script>
    const NUM_SENSORS = 6;
    const container = document.getElementById("sensors");
    let previousData = {};

    // Custom labels for sensors (in order)
    const SENSOR_LABELS = [
      "Living Room",
      "Kitchen",
      "Bedroom",
      "Garage",
      "Basement",
      "Office"
    ];

    async function fetchData() {
      try {
        const response = await fetch("https://govee-data.deviyl.workers.dev/");
        const data = await response.json();

        container.innerHTML = "";

        for (let i = 1; i <= NUM_SENSORS; i++) {
          const sensor = data[`SENSOR_${i}`];
          if (!sensor) continue;

          const temp = parseFloat((sensor.temperature ?? 0).toFixed(1));
          const humidity = parseFloat((sensor.humidity ?? 0).toFixed(1));

          const sensorDiv = document.createElement("div");
          sensorDiv.className = "sensor-card";

          // Apply temperature-based color tint
          const color = getTemperatureColor(temp);
          sensorDiv.style.background = `linear-gradient(135deg, ${color.light}, ${color.main})`;

          // Inner HTML structure with top/bottom halves and label at bottom
          sensorDiv.innerHTML = `
            <div class="sensor-top">
              <div class="sensor-temp" id="temp_${i}">${temp}°F</div>
            </div>
            <div class="sensor-bottom">
              <div class="sensor-divider"></div>
              <div class="sensor-humidity" id="hum_${i}">${humidity}%</div>
            </div>
            <div class="sensor-label">${SENSOR_LABELS[i - 1] ?? `SENSOR_${i}`}</div>
          `;

          container.appendChild(sensorDiv);

          animateValue(`temp_${i}`, previousData[`temp_${i}`] ?? temp, temp, 600, 1);
          animateValue(`hum_${i}`, previousData[`hum_${i}`] ?? humidity, humidity, 600, 1);

          previousData[`temp_${i}`] = temp;
          previousData[`hum_${i}`] = humidity;
        }
      } catch (err) {
        console.error("Error fetching sensor data:", err);
      }
    }

    function animateValue(id, start, end, duration, decimals = 0) {
      if (start === end) return;
      const element = document.getElementById(id);
      const range = end - start;
      let startTime = null;

      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const value = (start + range * progress).toFixed(decimals);
        element.textContent = value + (id.startsWith("temp") ? "°F" : "%");
        if (progress < 1) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    function getTemperatureColor(temp) {
      if (isNaN(temp)) return { light: "#e0f7fa", main: "#b2ebf2" };
      if (temp < 60) return { light: "#d0e8ff", main: "#90caf9" };
      if (temp < 75) return { light: "#e0f7fa", main: "#b2ebf2" };
      if (temp < 85) return { light: "#fff3e0", main: "#ffcc80" };
      return { light: "#ffebee", main: "#ef9a9a" };
    }

    fetchData();
    setInterval(fetchData, 60000); // refresh every 60 seconds
  </script>
</body>
</html>
